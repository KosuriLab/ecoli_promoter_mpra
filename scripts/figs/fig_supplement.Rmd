---
title: "Endo_supplement"
output: html_document
---

```{r setup, include=FALSE}
load_pkgs <- function(pkgs){
    new_pkgs <- pkgs[!(pkgs %in% installed.packages()[, 'Package'])]
    if(length(new_pkgs)) install.packages(new_pkgs)
    for(pkg in pkgs){
        suppressWarnings(suppressMessages(library(pkg, character.only = T)))
    }
}

pkgs <- c('dplyr', 'tidyr', 'ggplot2', 'cowplot', 'psych', 'matrixStats', 'sqldf')
load_pkgs(pkgs)

options(stringsAsFactors = F)
options(scipen = 10000)

```


For each of these 18,000 TSS promoters and controls we generated an average of 50 reporter constructs in which each construct expressed a uniquely barcoded GFP (Figure S1)

```{r}
Endo2 <- read.table("../../processed_data/endo_tss/lb/rLP5_Endo2_lb_expression_formatted_std.txt", 
                    header = T, fill  = T)

median_barcodes <- median(Endo2$num_barcodes_integrated)

ggplot(Endo2, aes(x = num_barcodes_integrated)) +
    geom_histogram(color = 'black') +
    scale_x_log10() +
    labs(title = "Distribution of the number of \n barcodes per TSS",
         x = "Number of barcodes",
         y = 'Counts') +
    annotation_logticks(sides = 'b') +
    geom_vline(xintercept = median_barcodes, color = 'red', linetype = 'dashed') +
    annotate('text', x = 12, y = 1500, 
             label = paste("Median =", median_barcodes, "barcodes"))

ggsave('../../figs/supp_figs/figS1_endo_barcode_distribution.pdf', units = 'in',
       width = 8, height = 5)
```

Figure S2 - COmparing alternative LP locations
```{r} 
fLP3 <- read.table("../../processed_data/endo_tss/alt_landing_pads/fLP3/fLP3_Endo2_lb_expression_formatted_std.txt", 
                   header = T) %>% 
    select(name, fLP3 = expn_med_fitted_scaled) %>%
    mutate(fLP3 = log10(as.numeric(fLP3)))



rLP6 <- read.table("../../processed_data/endo_tss/alt_landing_pads/rLP6/rLP6_Endo2_lb_expression_formatted_std.txt", 
                   header = T) %>%
          select(name, rLP6 = expn_med_fitted_scaled) %>%
          mutate(rLP6 = log10(as.numeric(rLP6)))

compare_locations <- inner_join(Endo2, fLP3, by = 'name') %>% 
    inner_join(., rLP6, by = 'name') %>%
    select('Right Midreplichore' = fLP3,
           'Terminus' = expn_med_fitted_scaled, 
           'Left Midreplichore' = rLP6) %>% 
    mutate(Terminus = log10(Terminus))

pdf('../../figs/supp_figs/figS2_alt_lp_correlation.pdf', width = 8, height = 6)
pairs.panels(compare_locations, 
             method = "pearson", 
             hist.col = "#00AFBB",
             lm = T,
             breaks = 30,
             rug = F,
             density = FALSE,
             cex.labels = 2, font.labels = 1.5)
dev.off()
```


Interestingly, we found a positive correlation between the number of transcription factor sites a promoter contained and how variable a promoter was between locations (Figure S2).

# ```{r}
# 
# compare_locations <- inner_join(Endo2, fLP3, by = c('name' = 'orig_name')) %>% 
#     inner_join(., rLP6, by = c('name' = 'orig_name')) %>%
#     select('Right Midreplichore'=fLP3,'Terminus'=RNA_exp_average, 'Left Midreplichore' = rLP6, name, var_start, var_end) %>% #pairs(.)
#     mutate(Terminus = log10(Terminus))
# 
# compare_locations <- compare_locations %>% select(`Right Midreplichore`, Terminus, `Left Midreplichore`) %>%
#     mutate(sds = rowSds(as.matrix(.)), mean = rowMeans(.), cv = (sds/mean)) %>% select(cv, sds, mean) %>% cbind(compare_locations, .)
# 
# tf_sites <- read.table('../ref/tf_sites.bed', col.names = c('genome', 'tf_start', 'tf_end', 'tf')) %>% select('tf', 'tf_start', 'tf_end')
# 
# 
# TFperProm <- sqldf("SELECT a.*, b.*
#                     FROM compare_locations AS a 
#                     JOIN tf_sites AS b
#                     ON b.tf_start BETWEEN a.var_start AND a.var_end
#                     OR b.tf_end BETWEEN a.var_start AND a.var_end") %>%
#                     na.omit() %>%
#                     group_by(name) %>%
#                     mutate(num_sites = n()) %>%
#                     select(name, cv, num_sites) %>% distinct()
# 
# ggplot(TFperProm, aes(x=as.character(num_sites, y = cv)) + geom_jitter() + geom_boxplot() + ylim(-10, 10)
# 
# ggplot(filter(TFperProm, num_sites < 10), aes(x=as.character(num_sites), y=cv)) +
#   scale_x_discrete() +
#   geom_jitter(aes(color = num_sites), alpha=.4, size=.4) +
#   geom_boxplot(alpha=.1, outlier.size = .2) +
#   scale_y_log10() +#limits = c(1e-06, 1e-0)) +
#   #geom_hline(yintercept = 0.002330774, color = 'red', linetype = 'dashed') +
#   viridis::scale_color_viridis(direction = -1) +
#   labs(x='Number of Regulating TF sites', y = 'Location-Dependent Variance', title = 'Promoter variance increases \n with regulatory complexity')
# 
# 
# 
# ```


Using our pipeline, we measured the transcriptional activity of 344,000 fragments with a median size of 241 bp spanning the entire E. coli genome with 10x coverage on average (Supplementary Figure 4)

```{r}
frag_expression <- read.table("../../processed_data/frag/lb/U00096.2_frag-rLP5_LB_expression.txt", 
           header = T) %>% mutate(frag_length = end - start)

median_frag_length <- median(frag_expression$frag_length)
sum_fragments <- sum(frag_expression$frag_length)

ggplot(frag_expression, aes(frag_length)) + 
    geom_histogram(color = 'black') +
    labs(title = "Distribution of assayed fragment size",
         x = "Length of Fragment (bp)",
         y = 'Counts') +
    geom_vline(xintercept = median_frag_length, color = 'red', 
               linetype = 'dashed') +
    annotate('text', x = 400, y = 50000, size = 8,
             label = paste("Median =", median_frag_length, "bp")) +
    annotate('text', x = 400, y = 45000, size = 8,
             label = paste(signif(sum_fragments/(4639675*2), 3), 
                           "X", " coverage", sep = '')) +
    theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
          axis.title.x = element_text(size = 20),
          axis.text.y = element_text(size = 20), 
          axis.title.y = element_text(size = 20), 
          legend.text = element_text(size = 20)) 

ggsave('../../figs/supp_figs/figS4_frag_size_distribution.pdf', units = 'in',
       width = 8, height = 5)
```


We averaged the expression of all fragments overlapping each genomic position to achieve highly replicable values of promoter activity at single-nucleotide resolution and in a strand-specific manner (Supplementary Figure 5)

```{r}


```


Our assay of genomic fragments identified regions of promoter activity that were fairly broad (Figure S6) and well above the expected size of regulated promoters
```{r}
peak_lengths <- read.table('../../processed_data/frag/lb/U00096.2_plus_minus_called_peaks_threshold1.1_merge40_min60.bed',
           col.names = c('genome', 'peak_start', 'peak_end', 'name', 'score', 
                         'strand', 'peakscore', 'peak_max')) %>% 
    select(name, peak_start, peak_end) %>%
    mutate(peak_length = peak_end-peak_start)

med_peak_length <- median(peak_lengths$peak_length)

ggplot(peak_lengths, aes(x=peak_length)) +
    geom_histogram(color = 'black') +
    labs(title = "Distribution of identified promoter peaks",
         x = "Length of Peak (bp)",
         y = 'Counts') +
    scale_x_log10() + annotation_logticks(sides = 'b') +
    geom_vline(xintercept = med_peak_length, color = 'red', linetype = 'dashed') +
    annotate('text', x = 500, y = 300, size = 8,
             label = paste("Median =", med_peak_length, "bp")) +
    theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
          axis.title.x = element_text(size = 20),
          axis.text.y = element_text(size = 20), 
          axis.title.y = element_text(size = 20), 
          legend.text = element_text(size = 20)) 

ggsave('../../figs/supp_figs/figS6_peak_size_distribution.pdf', units = 'in',
       width = 8, height = 5)
```


We identified scrambled regions that significantly increased or decreased expression and found 773 and 2365 regions, respectively (Figure 5A). These sites were located throughout promoters and scrambling these sites resulted in dramatic changes in expression, some over 100-fold (Figure S9)
```{r}
read.table("../../processed_data/endo_scramble/endo_scramble_expression_formatted_std.txt", header = T) %>%
    filter(category != 'unscrambled') %>%
    ggplot(. , aes(relative_exp)) +
    geom_histogram(color = 'black', position = 'dodge', bins = 50) +
    labs(title = "Distribution of scramble effects",
         x = "Scramble Effect",
         y = 'Counts') +
    scale_x_log10() + scale_y_log10() + annotation_logticks(sides = 'l') +
    theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
          axis.title.x = element_text(size = 20),
          axis.text.y = element_text(size = 20), 
          axis.title.y = element_text(size = 20), 
          legend.text = element_text(size = 20)) 

ggsave('../../figs/supp_figs/figS9_scramble_effect_distribution.pdf', units = 'in',
       width = 8, height = 5)
```



Many of the increasing scrambles merged into longer sites (median 20bp, maximum 97bp), with the longer sites comprised of scrambles of moderate effect size (Figure SX).

```{r}
repressor_color <- '#000066'
activator_color <- '#FFD700'

read.table("../../processed_data/endo_scramble/scramble_merged_sites.txt", header = T) %>% 
    mutate(site_type_new = case_when(.$site_type == 'increased' ~ 'activating',
                                 .$site_type == 'reduced' ~ 'repressing')) %>% 
    ggplot(., aes(site_length)) +
    geom_histogram(color = 'black', aes(fill = site_type_new)) +
    scale_fill_manual(values = c(repressor_color, activator_color)) +
    scale_y_log10(limits = c(1,600)) + annotation_logticks(sides = 'l') +
    labs(x = "Length of regulatory element (bp)",
         y = 'Counts',
         fill = '') +
    theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
          axis.title.x = element_text(size = 20),
          axis.text.y = element_text(size = 20), 
          axis.title.y = element_text(size = 20), 
          legend.text = element_text(size = 20)) +
    facet_wrap(~site_type_new)

ggsave('../../figs/supp_figs/figSX_merged_scramble_length_distribution.pdf',
       units = 'in', width  = 10, height = 5)
```







