---
title: "Endo_supplement"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = '~/Google Drive/Kosuri_Lab/Endo_Paper/scripts/')
#setwd("C:/Users/george/Google Drive/Kosuri_Lab/Endo_Paper/scripts")
#setwd("~/../Google Drive/Kosuri_Lab/ecoli_promoter_mpra (1)/scripts/")
#setwd("~/Google Drive/Kosuri_Lab/Endo_Paper/scripts/")
setwd('~/../Google Drive/Kosuri_Lab/ecoli_promoter_mpra (1)/scripts/figs')
knitr::opts_knit$set(root.dir = '~/Google Drive/Kosuri_Lab/ecoli_promoter_mpra (1)/scripts/figs')
library("ggplot2")
library("dplyr")
library("tidyr")
require("cowplot")
library("bbplot")
library(psych)
library(reshape2)
library(matrixStats)
library(sqldf)

options(stringsAsFactors = F)
options(scipen = 10000)

```


For each of these 18,000 TSS promoters and controls we generated an average of 50 reporter constructs in which each construct expressed a uniquely barcoded GFP (Figure S1)

Figure S1A
```{r}
Endo2 <- read.table("../../processed_data/endo_tss/lb/rLP5_Endo2_lb_expression_formatted_std.txt", header = T, fill  = T)

#Figure S1A - Distribution of the number of barcodes per TSS
median_barcodes <- median(Endo2$num_barcodes_integrated)

ggplot(Endo2, aes(x=num_barcodes_integrated)) +
      geom_histogram(color = 'black') +
      scale_x_log10() +
      labs(x = "Number of barcodes",
            y = 'Counts') +
      annotation_logticks(sides = 'b') +

      geom_vline(xintercept = median_barcodes, color = 'red', linetype = 'dashed') +
      annotate('text', x = 12, y = 1500, label = paste("Median =", median_barcodes, "barcodes"))



ggsave('../../figs/supp_figs/S1_barcodesperTSS.png', units = 'in', width = 7.29, height = 4.51)

```

Figure S1B - COmparing alternative LP locations
```{r} 
fLP3 <- read.table("../../processed_data/endo_tss/alt_landing_pads/fLP3/fLP3_Endo2_lb_expression_formatted_std.txt", header = T) %>% 
      select(name, fLP3=expn_med_fitted_scaled) %>%
      mutate(fLP3 = log10(as.numeric(fLP3)))



rLP6 <- read.table("../../processed_data/endo_tss/alt_landing_pads/rLP6/rLP6_Endo2_lb_expression_formatted_std.txt", header = T) %>%
          select(name, rLP6=expn_med_fitted_scaled) %>%
          mutate(rLP6 = log10(as.numeric(rLP6)))

compare_locations <- inner_join(Endo2, fLP3, by = 'name') %>% 
    inner_join(., rLP6, by = 'name') %>%
    select('Right Midreplichore'=fLP3,'Terminus'=expn_med_fitted_scaled, 'Left Midreplichore' = rLP6) %>% 
    mutate(Terminus = log10(Terminus))


pairs.panels(compare_locations, 
             method = "pearson", 
             hist.col = "#00AFBB",
             lm = T,
             breaks = 30,
             rug = F,
             density = FALSE,
             cex.axis = 3,
             stars = T,
             cex.labels = 3, font.labels =3)


ggsave('../../figs/supp_figs/S1B_ReplicatesBetweenLocation.png', units = 'in', width = 7.29, height = 4.51)
```


Interestingly, we found a positive correlation between the number of transcription factor sites a promoter contained and how variable a promoter was between locations (Figure S2).

# ```{r}
# 
# compare_locations <- inner_join(Endo2, fLP3, by = c('name' = 'orig_name')) %>% 
#     inner_join(., rLP6, by = c('name' = 'orig_name')) %>%
#     select('Right Midreplichore'=fLP3,'Terminus'=RNA_exp_average, 'Left Midreplichore' = rLP6, name, var_start, var_end) %>% #pairs(.)
#     mutate(Terminus = log10(Terminus))
# 
# compare_locations <- compare_locations %>% select(`Right Midreplichore`, Terminus, `Left Midreplichore`) %>%
#     mutate(sds = rowSds(as.matrix(.)), mean = rowMeans(.), cv = (sds/mean)) %>% select(cv, sds, mean) %>% cbind(compare_locations, .)
# 
# tf_sites <- read.table('../ref/tf_sites.bed', col.names = c('genome', 'tf_start', 'tf_end', 'tf')) %>% select('tf', 'tf_start', 'tf_end')
# 
# 
# TFperProm <- sqldf("SELECT a.*, b.*
#                     FROM compare_locations AS a 
#                     JOIN tf_sites AS b
#                     ON b.tf_start BETWEEN a.var_start AND a.var_end
#                     OR b.tf_end BETWEEN a.var_start AND a.var_end") %>%
#                     na.omit() %>%
#                     group_by(name) %>%
#                     mutate(num_sites = n()) %>%
#                     select(name, cv, num_sites) %>% distinct()
# 
# ggplot(TFperProm, aes(x=as.character(num_sites, y = cv)) + geom_jitter() + geom_boxplot() + ylim(-10, 10)
# 
# ggplot(filter(TFperProm, num_sites < 10), aes(x=as.character(num_sites), y=cv)) +
#   scale_x_discrete() +
#   geom_jitter(aes(color = num_sites), alpha=.4, size=.4) +
#   geom_boxplot(alpha=.1, outlier.size = .2) +
#   scale_y_log10() +#limits = c(1e-06, 1e-0)) +
#   #geom_hline(yintercept = 0.002330774, color = 'red', linetype = 'dashed') +
#   viridis::scale_color_viridis(direction = -1) +
#   labs(x='Number of Regulating TF sites', y = 'Location-Dependent Variance', title = 'Promoter variance increases \n with regulatory complexity')
# 
# 
# 
# ```




Using our pipeline, we measured the transcriptional activity of 344,000 fragments with a median size of 241 bp spanning the entire E. coli genome with 10x coverage on average (Supplementary Figure 4)
```{r}
frag_expression <- read.table("../../", 
           header = T) %>% mutate(frag_length = end - start)

median_frag_length <- median(frag_expression$frag_length)
sum_fragments <- sum(frag_expression$frag_length)

a <- ggplot(frag_expression, aes(frag_length)) + 
      geom_histogram(color = 'black') +
      labs(x = "Length of Fragment (bp)",
            y = 'Counts') +
      geom_vline(xintercept = median_frag_length, color = 'red', linetype = 'dashed') +
      annotate('text', x = 400, y = 50000, label = paste("Median =", median_frag_length, "bp"), size = 8) +
  annotate('text', x = 400, y = 45000, label = paste(signif(sum_fragments/(4639675*2), 3), "X", " coverage", sep = ''), size = 8) +
  theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
                axis.title.x = element_text(size = 20),
                axis.text.y = element_text(size = 20), 
                axis.title.y = element_text(size = 20), 
                legend.text=element_text(size=20)) 


cor <- cor(frag_expression$RNA_exp_1, frag_expression$RNA_exp_2)

b <- ggplot(frag_expression, aes(RNA_exp_1, RNA_exp_2)) + 
  geom_point() +
  scale_x_log10() + scale_y_log10() + annotation_logticks(sides= 'bl') +
  annotate("text", label=paste("italic(r)==",signif(cor, 3)),parse=TRUE, x=.5, y=15, size = 8) +
  xlab('Biological Replicate #1') + ylab('Biological Replicate #2') +
  theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))

##Figure S2C

# read in barcode count files
filelist = list.files(path = "../../processed_data/frag/lb",
                      pattern = '*_rep',
                      full.names = T)

# should be named so files are in following order, number is biological replicate

sample_names = c('Minus_1', 'Minus_2', 'Plus_1', 'Plus_2')

for(i in seq(1:length(filelist))) {
    sample_name <- sample_names[i]
    x <- read.table(filelist[i], col.names=c('position', sample_name), header = F, skip = 1)
    x[[sample_name]] <- 1000000*x[[sample_name]]/sum(x[[sample_name]])  #Normalizes by RPM
    assign(sample_name, x)  
}

count_list <- list(Minus_1, Minus_2, Plus_1, Plus_2)

set.seed(123)
nucleotide_exp <- count_list %>% purrr::reduce(full_join, by = "position") %>% sample_n(50000, replace = F) %>% 
  melt(id = 'position') %>% 
  separate(variable, by = '_', into = c('strand', 'replicate')) %>% 
  spread(key = 'replicate', value = 'value')

cor <- cor(nucleotide_exp$`1`, nucleotide_exp$`2`)    

c <- ggplot(nucleotide_exp, aes(`1`, `2`)) + 
  geom_point() +
  scale_x_log10() + scale_y_log10() + annotation_logticks(sides= 'bl') +
  annotate("text", label=paste("italic(r)==",signif(cor, 3)),parse=TRUE, x=.1, y=5, size = 8) +
  xlab('Biological Replicate #1') + ylab('Biological Replicate #2') +
  theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))


##Figure S2D 
peak_lengths <- read.table('../../processed_data/frag/lb/U00096.2_plus_minus_called_peaks_threshold1.1_merge40_min60.bed',
           col.names = c('genome', 'peak_start', 'peak_end', 'name', 'score', 'strand', 'peakscore', 'peak_max')) %>% select(name, peak_start, peak_end) %>% mutate(peak_length = peak_end-peak_start)

med_peak_length <- median(peak_lengths$peak_length)

d <- ggplot(peak_lengths, aes(x=peak_length)) +
    geom_histogram(color = 'black') +
      labs(x = "Length of Peak (bp)",
            y = 'Counts') +
    scale_x_log10() +
    annotation_logticks(sides = 'b') +
      geom_vline(xintercept = med_peak_length, color = 'red', linetype = 'dashed') +
      annotate('text', x = 500, y = 300, label = paste("Median =", med_peak_length, "bp"), size = 8) +
  theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
                axis.title.x = element_text(size = 20),
                axis.text.y = element_text(size = 20), 
                axis.title.y = element_text(size = 20), 
                legend.text=element_text(size=20)) 

plot_grid(a,b,c,d, ncol = 2, labels = 'AUTO')

ggsave('../../figs/supp_figs/S2_Fragstats.png', units = 'in', width = 14.29, height = 10.51)

```


<!-- S5 - Are unique M9 and Lb promoters just noise? -->
<!-- ```{r} -->
<!-- M9_only <- read.table("../processed_data/frag/Unshared_M9_peaks.bed", header = F) %>% -->
<!--     select(peak_name = V4, peak_max = V8, peak_score = V5, peak_strand =  V6) %>% -->
<!--     mutate(Condition = "M9") -->

<!-- LB_only <- read.table("../processed_data/frag/Unshared_LB_peaks.bed", header = F) %>% -->
<!--     select(peak_name = V4, peak_max = V8, peak_score = V5, peak_strand =  V6) %>% -->
<!--     mutate(Condition = "LB") -->

<!-- shared_M9 <-  read.table("../processed_data/frag/Shared_peaks.bed", header = F) %>% -->
<!--     select(peak_name = V4, peak_max = V8, peak_score = V5, peak_strand = V6) %>% -->
<!--     mutate(Condition = "Shared M9") -->

<!-- shared_LB <-  read.table("../processed_data/frag/Shared_peaks.bed", header = F) %>% -->
<!--     select(peak_name = V4, peak_max = V8, peak_score = V13, peak_strand = V6) %>% -->
<!--     mutate(Condition = "Shared LB") -->


<!-- rbind(M9_only, shared_M9, shared_LB, LB_only) %>% -->
<!--     ggplot(aes(y=peak_score, x = Condition, fill = Condition)) + geom_boxplot(outlier.shape = NA) + scale_y_log10() -->

<!-- read.table("../processed_data/frag/Shared_peaks.bed", header = F) %>% -->
<!--     ggplot(aes(V13, V5)) + -->
<!--     geom_point() + -->
<!--     scale_x_log10() + -->
<!--     scale_y_log10() + -->
<!--     annotation_logticks(sides = 'bl') + -->
<!--     geom_abline(intercept = 0, slope =1, linetype = 'dashed', color = 'red') + geom_smooth(method = 'lm') -->


<!-- shared <- read.table("../processed_data/frag/Shared_peaks.bed", header = F) -->
<!-- t.test(shared$V13, shared$V5) -->

<!-- ``` -->





<!-- Our assay of genomic fragments identified regions of promoter activity that were fairly broad (Figure S4) and well above the expected size of regulated promoters -->
<!-- ```{r} -->

<!-- peak_lengths <- read.table('../../processed_data/frag/lb/U00096.2_plus_minus_called_peaks_threshold1.1_merge40_min60.bed', -->
<!--            col.names = c('genome', 'peak_start', 'peak_end', 'name', 'score', 'strand', 'peakscore', 'peak_max')) %>% select(name, peak_start, peak_end) %>% mutate(peak_length = peak_end-peak_start) -->

<!-- med_peak_length <- median(peak_lengths$peak_length) -->

<!--   ggplot(peak_lengths, aes(x=peak_length)) + -->
<!--     geom_histogram(color = 'black') + -->
<!--       labs(title = "Distribution of identified promoter peaks", -->
<!--             x = "Length of Peak (bp)", -->
<!--             y = 'Counts') + -->
<!--     scale_x_log10() + -->
<!--     annotation_logticks(sides = 'b') + -->
<!--       geom_vline(xintercept = med_peak_length, color = 'red', linetype = 'dashed') + -->
<!--       annotate('text', x = 500, y = 300, label = paste("Median =", med_peak_length, "bp"), size = 8) + -->
<!--   theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), -->
<!--                 axis.title.x = element_text(size = 20), -->
<!--                 axis.text.y = element_text(size = 20), -->
<!--                 axis.title.y = element_text(size = 20), -->
<!--                 legend.text=element_text(size=20)) -->

<!-- ggsave('../../figs/supplementary/S4_PeakSizes.png', units = 'in', width = 7.29, height = 4.51) -->

<!-- ``` -->



S3 - QC of scramble and Peak Libraries

```{r}
scram_data <- read.table('../../processed_data/endo_scramble/endo_scramble_expression_formatted_std.txt', header = T)

median_barcodes <- median(scram_data$num_barcodes_integrated)

a <- ggplot(scram_data, aes(x=num_barcodes_integrated)) +
      geom_histogram(color = 'black') +
      labs(x = "Number of barcodes",
            y = 'Counts') +
      geom_vline(xintercept = median_barcodes, color = 'red', linetype = 'dashed') +
      annotate('text', x = 30, y = 5000, 
                label = paste("Median =", median_barcodes, "barcodes"), size = 8) +
      theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))

neg <- subset(scram_data, grepl("neg_control", scram_data$name)) %>% subset(!grepl('scrambled', .$name))
threshold <- 1

cor <- cor(scram_data$RNA_exp_sum_1, scram_data$RNA_exp_sum_2)

b <- ggplot(scram_data, aes(RNA_exp_sum_1, RNA_exp_sum_2)) + 
  geom_point() +
  scale_x_log10() + scale_y_log10() + annotation_logticks(sides= 'bl') +
  annotate("text", label=paste("italic(r)==",signif(cor, 3)),parse=TRUE, x=.5, y=15, size = 8) +
  xlab('Biological Replicate #1') + ylab('Biologial Replicate #2') +
  geom_point(data=neg,aes(RNA_exp_sum_1, RNA_exp_sum_2), color = "firebrick1") +
  annotate("text", label = "Negative Controls", x = 10, y = .1, color = 'firebrick1', size = 8) +
  theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))


#Statistics for Peak Tiling library

peak_data <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt', header = T)

median_barcodes <- median(peak_data$num_barcodes_integrated)

c <- ggplot(peak_data, aes(x=num_barcodes_integrated)) +
      geom_histogram(color = 'black') +
      labs(x = "Number of barcodes",
            y = 'Counts') +
      geom_vline(xintercept = median_barcodes, color = 'red', linetype = 'dashed') +
      annotate('text', x = 30, y = 5000, 
               label = paste("Median =", median_barcodes, "barcodes"), size = 8) +
       theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))

neg <- subset(peak_data, grepl("neg_control", peak_data$name))
threshold <- 1

cor <- cor(peak_data$RNA_exp_sum_1, peak_data$RNA_exp_sum_2)

d <- ggplot(peak_data, aes(RNA_exp_sum_1, RNA_exp_sum_2)) + 
  geom_point() +
  scale_x_log10() + scale_y_log10() + annotation_logticks(sides= 'bl') +
  annotate("text", label=paste("italic(r)==",signif(cor, 3)),parse=TRUE, x=.5, y=15, size = 8) +
  xlab('Biological Replicate #1') + ylab('Biological Replicate #2') +
  geom_point(data=neg,aes(RNA_exp_sum_1, RNA_exp_sum_2), color = "firebrick1") +
  annotate("text", label = "Negative Controls", x = 20, y = .5, color = 'firebrick1', size = 8) +
  theme(axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24))

plot_grid(c,d,a,b, ncol = 2, labels = 'AUTO')

ggsave('../../figs/supp_figs/S3_peakstats_scramstats.png', units = 'in', width = 14.29, height = 10.51)


```


S4 - Promoters per peak by size

```{r}

#filter(collapsed_per_Peak, num_sub_peaks == 0) %>% nrow()

read.table("../../processed_data/peak_tile/collapsed_per_peak.bed") %>%
    mutate(length = V3-V2) %>% select(length, V9) %>%
  ggplot(aes(length, fill = as.character(V9))) +
    geom_density( bins = 70, alpha = .4) +
    viridis::scale_fill_viridis(discrete = T) +
    #scale_x_log10() +
#    scale_y_log10() + annotation_logticks(sides = 'bl') + 
    labs(x = 'Promoter Region Size (bp)', y = 'Count', fill = 'Number of Promoters') + 
  geom_vline(xintercept = 150, linetype = 'dashed', color = 'red') +
  annotate('text', x = 270, y = .007, label = '150 bp', color = 'red', size = 6) +
theme(legend.position = 'top',
      axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24),
      legend.text = element_text(size = 20),
      legend.title = element_text(size = 20))

ggsave('../../figs/supp_figs/S4_promotersPerPeak.png', units = 'in', width = 7.29, height = 4.51)

```





We identified scrambled regions that significantly increased or decreased expression and found 773 and 2365 regions, respectively (Figure 5A). These sites were located throughout promoters and scrambling these sites resulted in dramatic changes in expression, some over 100-fold (Figure S9)
```{r}

repressor_color <- '#000066'
activator_color <- '#FFD700'

data <-  read.table('../../processed_data/endo_scramble/endo_scramble_expression_formatted_std.txt', header = T)
ttest <- read.table('../../processed_data/endo_scramble/endo_scramble_ttests.txt', header = T)
data <- left_join(data, select(ttest, -tss_name), by = 'name')
scramble_merged <- read.table("../../processed_data/endo_scramble/scramble_merged_sites.txt", header = T)

scramble_merged_parts <- scramble_merged %>% 
    mutate(scramble_list = strsplit(scrambles, split = ',TSS')) %>% 
    unnest(scramble_list) %>% 
    mutate(scramble_part = gsub('TSS', '', scramble_list),
           scramble_part = paste0('TSS', scramble_part),
           scramble_part = gsub('TSSneg', 'neg', scramble_part)) %>% 
    select(-scramble_list) %>% 
    left_join(select(data, name, scramble_pos_rel_tss), by = c('scramble_part' = 'name'))
```


```{r}

a <- data %>%  
    mutate("classification" = ifelse(relative_exp > 1, "Repressing", "Activating")) %>%
    filter(category != 'unscrambled') %>%
    ggplot(. , aes(relative_exp, fill = classification)) +
      geom_histogram(color = 'black', bins = 100) +
      scale_fill_manual(values = c('#FFD700', '#000066')) +
      labs(#title = "Distribution of scramble effects",
            x = "Scramble relative expression",
            y = 'Counts') +
  scale_x_log10() +
  annotation_logticks(sides = 'b') +
  theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
                axis.title.x = element_text(size = 20),
                axis.text.y = element_text(size = 20), 
                axis.title.y = element_text(size = 20), 
                legend.text=element_text(size=20),
        legend.position = 'top') 



b <- scramble_merged_parts %>% 
    filter(site_type == 'reduced', !is.na(tf_concordance)) %>%
    ggplot(aes(scramble_pos_rel_tss)) + 
    geom_bar(aes(fill=tf_concordance)) +
    scale_x_continuous(breaks = c(-120, 80, 40, 0)) +
    scale_fill_manual(values = c('#FFBC42', '#0496FF'), na.value = 'gray38') +
    labs(fill = 'TF concordance',
         x = 'Scramble position relative to TSS',
         title = 'Repressors') +
        theme(axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20),
        axis.title.x.bottom = element_text(size = 20),
        axis.title.y.left = element_text(size = 20),
        legend.position = 'top')

c <- scramble_merged_parts %>% 
    filter(site_type == 'increased', !is.na(tf_concordance)) %>%
    ggplot(aes(scramble_pos_rel_tss)) + 
    geom_bar(aes(fill=tf_concordance)) +
      scale_x_continuous(breaks = c(-120, 80, 40, 0)) +
    scale_fill_manual(values = c('#FFBC42', '#0496FF'), na.value = 'gray38') +
    labs(fill = 'TF concordance',
         x = 'Scramble position relative to TSS',
         title = 'Activators') +
        theme(axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20),
        axis.title.x.bottom = element_text(size = 20),
        axis.title.y.left = element_text(size = 20),
        legend.position = 'top')


d <- scramble_merged %>% 
    mutate(length = scramble_end_pos - scramble_start_pos) %>% 
    mutate(site_type_mod = case_when(.$site_type == 'increased' ~ 'Activating',
                                 .$site_type == 'reduced' ~ 'Repressing')) %>% 
    ggplot(aes(length)) + 
    geom_histogram(aes(fill = site_type_mod), position = 'dodge', binwidth = 10, color = 'black') +
    scale_fill_manual(values = c(repressor_color, activator_color), na.value = 'gray65') +
    scale_x_continuous(breaks = seq(0, 100, 10)) +
    labs(fill = '', x = 'Merged scramble length (bp)', y = 'Counts') +
      theme(axis.text.x = element_text(size=20, angle = 45, hjust = 1), 
        axis.text.y = element_text(size=20),
        axis.title.x.bottom = element_text(size = 20),
        axis.title.y.left = element_text(size = 20),
        legend.position = 'top')


e <- scramble_merged_parts %>% 
    mutate(length = scramble_end_pos - scramble_start_pos,
           length_bin = cut(length, breaks = seq(0, 100, 10)),
           site_type_mod = case_when(.$site_type == 'increased' ~ 'Activating',
                                 .$site_type == 'reduced' ~ 'Repressing')) %>% 
    left_join(select(data, name, relative_exp), by = c('scramble_part' = 'name')) %>% 
    ggplot(aes(length_bin, relative_exp)) + 
    geom_boxplot(aes(fill = site_type_mod), position = 'dodge') +
    scale_y_log10() + annotation_logticks(sides = 'l') +
    scale_fill_manual(values = c(repressor_color, activator_color), na.value = 'gray65') + 
    labs(fill = '',
         x = 'Merged scramble length (bp)', 
         y = 'Relative expression') +
    theme(axis.text.x = element_text(size=20, angle = 45, hjust = 1), 
        axis.text.y = element_text(size=24),
        axis.title.x.bottom = element_text(size = 24),
        axis.title.y.left = element_text(size = 24),
      legend.text = element_text(size = 20),
      legend.title = element_text(size = 20),
      legend.position = 'top')

plot_grid(a,d,e,b,c, ncol = 3, labels = 'AUTO')

ggsave('../../figs/supp_figs/S5_Global.png', units = 'in', width = 14.29, height = 10.51)

```


S6 - Random Promoters
```{r}


#How many active randoms?
act_rand <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'random' & active == 'active') %>% nrow()
#How many total randoms?
rand <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'random') %>% nrow()

#How many active pos_controls?
act_pos <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'pos_control' & active == 'active') %>% nrow()
#How many total positive controls?
pos <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'pos_control') %>% nrow()

#How many active randoms?
act_neg <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'neg_control' & active == 'active') %>% nrow()
#How many total randoms?
neg <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'neg_control') %>% nrow()

#How many active randoms?
act_tile <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'tile' & active == 'active') %>% nrow()
#How many total randoms?
tile <- read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt',
                        header = T) %>% filter(category == 'tile') %>% nrow()

read.table('../../processed_data/peak_tile/peak_tile_expression_formatted_std.txt', header = T) %>% 
    ggplot(aes(category, expn_med_fitted_scaled)) + 
    geom_boxplot(fill = 'dodgerblue', alpha = .4) +
    scale_y_log10(limits = c(.5, 500)) +
    annotation_logticks(sides = 'l') +
    geom_hline(yintercept = 1, linetype = 'dashed') +
    scale_x_discrete(limits = c('pos_control', 'tile', 'random', 'neg_control'),
                    labels = c('Positive\ncontrols', 'Promoter\nregion\ntiles', 'Random\n150mers', 'Negative\ncontrols')) +
    scale_fill_discrete(labels = c('Positive controls', 'Promoter region tiles', 'Random 150mers', 'Negative controls')) +
    labs(x = '', color = '', y = 'Expression') +
    annotate('text', x='random', y = 200, label = paste(paste(act, '/', rand, sep = ''), ' active', '\n(', signif(act/rand,3)*100, '%)', sep = ''), size = 5) +
    annotate('text', x='pos_control', y = 200, label = paste(paste(act_pos, '/', pos, sep = ''), ' active', '\n(', signif(act_pos/pos,3)*100, '%)', sep = ''), size = 5) +
    annotate('text', x='neg_control', y = 200, label = paste(paste(act_neg, '/', neg, sep = ''), ' active', '\n(', signif(act_neg/neg,3)*100, '%)', sep = ''), size = 5) +
    annotate('text', x='tile', y = 200, label = paste(paste(act_tile, '/', tile, sep = ''), ' active', '\n(', signif(act_tile/tile,3)*100, '%)', sep = ''), size = 5) +
    theme(axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20),
        axis.title.x.bottom = element_text(size = 20),
        axis.title.y.left = element_text(size = 20),
        legend.position = 'none') 

    

ggsave('../../figs/supp_figs/S6_RandomActivity.png', units = 'in', width = 7.25, height = 5.25)


```



```{}
read.table("../../processed_data/endo_scramble/scramble_merged_sites.txt", header = T) %>% 
    ggplot(., aes(site_length)) +
      geom_histogram(color = 'black', aes(fill = site_type)) +
      labs(x = "Length of regulatory element (bp)",
            y = 'Counts') +
   scale_y_log10(limits = c(1,600)) +
    annotation_logticks(sides = 'l') +
  theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1), 
                axis.title.x = element_text(size = 20),
                axis.text.y = element_text(size = 20), 
                axis.title.y = element_text(size = 20), 
                legend.text=element_text(size=20)) +
  facet_wrap(~site_type)

```







